name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to droplet
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: 165.227.201.91
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          use_insecure_cipher: true
          command_timeout: 15m
          script: |
            cd /root/jessicamendez
            git pull origin main
            cd web
            ~/.bun/bin/bun install

            # Zero-downtime deployment: build to temp directory
            rm -rf dist-new
            ASTRO_OUT_DIR=./dist-new ~/.bun/bin/bun run build

            # Atomic swap (nginx keeps serving old until swap completes)
            rm -rf dist-old
            [ -d dist ] && mv dist dist-old
            mv dist-new dist
            rm -rf dist-old
